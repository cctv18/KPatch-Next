name: Sync KPatch Artifacts

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 4:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 12:00)
    - cron: '0 4 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Latest Action Info & Download
        id: process
        env:
          UPSTREAM_REPO: "KernelSU-Next/KPatch-Next-Module"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å–æœ€æ–°æˆåŠŸçš„ Workflow Run ä¿¡æ¯ (åŒ¿åè¯·æ±‚ï¼Œæ— éœ€ Token å³å¯è¯»å–å…¬å…±ä»“åº“ä¿¡æ¯)
          echo "ğŸ” Fetching latest workflow run..."
          RUN_DATA=$(curl -s "https://api.github.com/repos/$UPSTREAM_REPO/actions/runs?status=success&per_page=1")
          
          # è§£æå…³é”®ä¿¡æ¯
          RUN_ID=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].id')
          RUN_NUMBER=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].run_number')
          HTML_URL=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].html_url')
          CREATED_AT=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].created_at')
          
          # è§£æ Commit ç›¸å…³ä¿¡æ¯
          HEAD_SHA=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].head_sha')
          SHORT_SHA=${HEAD_SHA:0:7}
          COMMIT_MSG=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].head_commit.message')
          AUTHOR_NAME=$(echo "$RUN_DATA" | jq -r '.workflow_runs[0].head_commit.author.name')

          # æ£€æŸ¥æ˜¯å¦è·å–æˆåŠŸ
          if [ "$RUN_ID" == "null" ]; then
            echo "âŒ Failed to fetch run info."
            exit 1
          fi
          
          echo "âœ… Found Run ID: $RUN_ID (Build #$RUN_NUMBER)"

          # 2. æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          # å¦‚æœå½“å‰ä»“åº“å·²ç»å‘å¸ƒè¿‡è¿™ä¸ª Run ID çš„ç‰ˆæœ¬ï¼Œåˆ™è·³è¿‡ï¼Œé¿å…é‡å¤å‘å¸ƒ
          TAG_NAME="build-$RUN_NUMBER"
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ Release $TAG_NAME already exists. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 3. æ ¼å¼åŒ–å‘å¸ƒè¯´æ˜ (Release Body)
          # è½¬æ¢æ—¶é—´æ ¼å¼ (å°è¯•è½¬æ¢ä¸ºç›´è§‚çš„æ ¼å¼)
          FORMATTED_DATE=$(date -d "$CREATED_AT" "+%b %d, %I:%M %p UTC")
          
          # æ„å»ºå¤šè¡Œæ–‡æœ¬ (EOF å—)
          BODY_TEXT="Build #$RUN_NUMBER: Commit $SHORT_SHA pushed by $AUTHOR_NAME
          $COMMIT_MSG
          $FORMATTED_DATE
          $HTML_URL"
          
          # å°†å¤šè¡Œæ–‡æœ¬å†™å…¥ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œå¤„ç†æ¢è¡Œç¬¦
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_title=Build #$RUN_NUMBER" >> $GITHUB_OUTPUT

          # 4. è·å– Artifact åç§°å¹¶ä¸‹è½½
          echo "ğŸ” Fetching artifact info..."
          ARTIFACT_LIST=$(curl -s "https://api.github.com/repos/$UPSTREAM_REPO/actions/runs/$RUN_ID/artifacts")
          ARTIFACT_NAME=$(echo "$ARTIFACT_LIST" | jq -r '.artifacts[0].name')
          
          if [ "$ARTIFACT_NAME" == "null" ]; then
            echo "âŒ No artifacts found."
            exit 1
          fi

          # ä½¿ç”¨ nightly.link å… Token ä¸‹è½½
          DOWNLOAD_URL="https://nightly.link/$UPSTREAM_REPO/actions/runs/$RUN_ID/$ARTIFACT_NAME.zip"
          
          echo "â¬‡ï¸ Downloading $ARTIFACT_NAME from $DOWNLOAD_URL..."
          curl -L -o kpn.zip "$DOWNLOAD_URL"

          # éªŒè¯æ–‡ä»¶
          if [ ! -f "kpn.zip" ]; then
            echo "âŒ Download failed."
            exit 1
          fi
          echo "âœ… Downloaded and renamed to kpn.zip"

      - name: Create Release
        # åªæœ‰å½“å‰é¢çš„æ­¥éª¤æ²¡æœ‰è¢«æ ‡è®°ä¸º skip æ—¶æ‰æ‰§è¡Œ
        if: steps.process.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Creating release..."
          
          gh release create "${{ steps.process.outputs.tag_name }}" \
            "kpn.zip" \
            --title "${{ steps.process.outputs.release_title }}" \
            --notes "${{ steps.process.outputs.release_body }}" \
            --repo "$GITHUB_REPOSITORY"

          echo "ğŸ‰ Release published: ${{ steps.process.outputs.tag_name }}"
