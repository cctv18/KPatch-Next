name: Sync KPatch Artifacts

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 4:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 12:00)
    - cron: '0 4 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Latest Info & Download
        id: process
        env:
          # ç›®æ ‡ä¸Šæ¸¸ä»“åº“
          UPSTREAM_REPO: "KernelSU-Next/KPatch-Next-Module"
          # ä½¿ç”¨ GH_TOKEN ç¯å¢ƒå˜é‡ï¼Œgh å‘½ä»¤ä¼šè‡ªåŠ¨è¯»å–å®ƒè¿›è¡Œèº«ä»½éªŒè¯
          # è¿™èƒ½è§£å†³ API Rate Limit é—®é¢˜ï¼Œè·å¾— 5000æ¬¡/å°æ—¶ çš„é¢åº¦
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Fetching latest workflow run info using GitHub CLI..."
          
          # ä½¿ç”¨ gh å‘½ä»¤è¡Œå·¥å…·è·å–ä¸Šæ¸¸ä»“åº“æœ€æ–°çš„æˆåŠŸæ„å»º
          # --json å‚æ•°æŒ‡å®šæˆ‘ä»¬éœ€è¦è·å–çš„å­—æ®µ
          RUN_JSON=$(gh api "repos/$UPSTREAM_REPO/actions/runs?status=success&per_page=1" --jq '.workflow_runs[0]')

          # è§£æå­—æ®µ
          RUN_ID=$(echo "$RUN_JSON" | jq -r '.id')
          RUN_NUMBER=$(echo "$RUN_JSON" | jq -r '.run_number')
          HTML_URL=$(echo "$RUN_JSON" | jq -r '.html_url')
          CREATED_AT=$(echo "$RUN_JSON" | jq -r '.created_at')
          HEAD_SHA=$(echo "$RUN_JSON" | jq -r '.head_sha')
          SHORT_SHA=${HEAD_SHA:0:7}
          
          # æå– commit message å’Œ author (æ³¨æ„å¤„ç†å¯èƒ½ä¸ºç©ºçš„æƒ…å†µ)
          COMMIT_MSG=$(echo "$RUN_JSON" | jq -r '.head_commit.message // "No commit message"')
          AUTHOR_NAME=$(echo "$RUN_JSON" | jq -r '.head_commit.author.name // "Unknown"')

          if [ "$RUN_ID" == "null" ] || [ -z "$RUN_ID" ]; then
            echo "âŒ Failed to fetch run info via gh CLI."
            exit 1
          fi
          
          echo "âœ… Found Run ID: $RUN_ID (Build #$RUN_NUMBER)"

          # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          TAG_NAME="build-$RUN_NUMBER"
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ Release $TAG_NAME already exists. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ ¼å¼åŒ–æ—¶é—´ (UTC -> Human Readable)
          FORMATTED_DATE=$(date -d "$CREATED_AT" "+%b %d, %I:%M %p UTC")
          
          # æ„å»º Release Body
          BODY_TEXT="Build #$RUN_NUMBER: Commit $SHORT_SHA pushed by $AUTHOR_NAME
          $COMMIT_MSG
          $FORMATTED_DATE
          $HTML_URL"
          
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_title=Build #$RUN_NUMBER" >> $GITHUB_OUTPUT

          # è·å– Artifact åç§°
          # æ³¨æ„ï¼šgh run view ä¹Ÿå¯ä»¥åˆ—å‡º artifactsï¼Œä½†è¿™é‡Œç”¨ API é…åˆ token æ¯”è¾ƒç›´æ¥
          echo "ğŸ” Fetching artifact name..."
          ARTIFACT_JSON=$(gh api "repos/$UPSTREAM_REPO/actions/runs/$RUN_ID/artifacts")
          ARTIFACT_NAME=$(echo "$ARTIFACT_JSON" | jq -r '.artifacts[0].name')
          
          if [ "$ARTIFACT_NAME" == "null" ]; then
            echo "âŒ No artifacts found."
            exit 1
          fi
          echo "âœ… Artifact Name: $ARTIFACT_NAME"

          DOWNLOAD_URL="https://nightly.link/$UPSTREAM_REPO/actions/runs/$RUN_ID/$ARTIFACT_NAME.zip"
          
          echo "â¬‡ï¸ Downloading from $DOWNLOAD_URL..."
          curl -L -o kpn.zip "$DOWNLOAD_URL"

          if [ ! -f "kpn.zip" ]; then
            echo "âŒ Download failed."
            exit 1
          fi
          echo "âœ… Downloaded and renamed to kpn.zip"

      - name: Create Release
        if: steps.process.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Creating release..."
          gh release create "${{ steps.process.outputs.tag_name }}" \
            "kpn.zip" \
            --title "${{ steps.process.outputs.release_title }}" \
            --notes "${{ steps.process.outputs.release_body }}" \
            --repo "$GITHUB_REPOSITORY"
